<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Management Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f4; color: #333; }
        header { background-color: #007bff; color: white; padding: 15px 0; text-align: center; }
        header h1 { margin: 0; }
        nav ul { list-style-type: none; padding: 0; text-align: center; background-color: #333; margin: 0; }
        nav ul li { display: inline; margin-right: 0; }
        nav ul li a { color: white; text-decoration: none; padding: 15px 20px; display: inline-block; }
        nav ul li a:hover { background-color: #555; }
        .container { margin: 20px; padding: 20px; background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }
        h1, h2, h3 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; }
        th { background-color: #007bff; color: white; }
        tr:hover { background-color: #f1f1f1; }
        .controls-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        .controls-section h2 { margin-top: 0; }
        .control-group { margin-bottom: 15px; }
        .control-group label { margin-right: 10px; }
        .control-group input[type="number"], .control-group input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .control-group button { padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .control-group button:hover { background-color: #218838; }
        .status-message { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        footer { text-align: center; margin-top: 30px; padding: 20px; background-color: #333; color: white; }
        .action-button { padding: 5px 10px; font-size: 0.9em; margin-right: 5px;}
    </style>
</head>
<body>
    <header>
        <h1>Smart City IoT Platform</h1>
    </header>

    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <!-- Add other main module links if known -->
        </ul>
    </nav>

    <div class="container">
        <h1>Streetlight Management Dashboard</h1>

        <h2>Streetlights Overview</h2>
        <div id="streetlightsContainer">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Location (Lat, Lon)</th>
                        <th>Status</th>
                        <th>Brightness (%)</th>
                        <th>Power (W)</th>
                        <th>Energy Usage (kWh)</th>
                        <th>Adaptive Lighting</th>
                        <th>Actions (Adaptive)</th>
                    </tr>
                </thead>
                <tbody id="streetlightsTableBody">
                    <!-- Streetlight data will be populated here by JavaScript -->
                </tbody>
            </table>
            <p id="streetlightsLoadingMsg">Loading streetlights...</p>
        </div>

        <div class="controls-section">
            <h2>Energy Simulation</h2>
            <div class="control-group">
                <label for="duration_hours">Duration (hours):</label>
                <input type="number" id="duration_hours" name="duration_hours" min="0.1" step="0.1" value="1">
                <button id="runSimulationBtn">Run Simulation</button>
            </div>
            <div id="simulationResult" class="status-message" style="display:none;"></div>
        </div>

        <div class="controls-section">
            <h2>Adaptive Lighting Schedule</h2>
            <div class="control-group">
                <label for="current_time_hour">Current Hour (0-23):</label>
                <input type="number" id="current_time_hour" name="current_time_hour" min="0" max="23" step="1" value="12">
                <button id="applyScheduleBtn">Apply Schedule</button>
            </div>
            <div id="scheduleResult" class="status-message" style="display:none;"></div>
        </div>

        <p style="margin-top: 20px;"><a href="/">Return to Main Dashboard</a></p>
    </div>

    <footer>
        <p>&copy; 2024 SmartCityIoT Project</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const streetlightsTableBody = document.getElementById('streetlightsTableBody');
            const streetlightsLoadingMsg = document.getElementById('streetlightsLoadingMsg');

            const durationInput = document.getElementById('duration_hours');
            const runSimulationBtn = document.getElementById('runSimulationBtn');
            const simulationResultDiv = document.getElementById('simulationResult');

            const hourInput = document.getElementById('current_time_hour');
            const applyScheduleBtn = document.getElementById('applyScheduleBtn');
            const scheduleResultDiv = document.getElementById('scheduleResult');

            async function loadStreetlights() {
                streetlightsLoadingMsg.textContent = 'Loading streetlights...';
                streetlightsLoadingMsg.style.display = 'block';
                streetlightsTableBody.innerHTML = ''; // Clear existing rows

                try {
                    const response = await fetch('/energy/streetlights');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const lights = await response.json();

                    if (lights.length === 0) {
                        streetlightsLoadingMsg.textContent = 'No streetlights found.';
                        return;
                    }

                    lights.forEach(light => {
                        const row = streetlightsTableBody.insertRow();
                        row.insertCell().textContent = light.light_id;
                        row.insertCell().textContent = `${light.location.lat.toFixed(4)}, ${light.location.lon.toFixed(4)}`;
                        row.insertCell().textContent = light.status;
                        row.insertCell().textContent = light.brightness_level;
                        row.insertCell().textContent = light.power_consumption_watts !== null ? light.power_consumption_watts : 'N/A';
                        row.insertCell().textContent = light.current_energy_usage !== null ? light.current_energy_usage.toFixed(3) : 'N/A';

                        const adaptiveStatus = light.adaptive_lighting_enabled ? "Enabled" : "Disabled";
                        row.insertCell().textContent = adaptiveStatus;

                        const adaptiveCell = row.insertCell();
                        const toggleBtn = document.createElement('button');
                        toggleBtn.classList.add('action-button');
                        toggleBtn.textContent = light.adaptive_lighting_enabled ? "Disable Adaptive" : "Enable Adaptive";
                        toggleBtn.dataset.lightId = light.light_id;
                        toggleBtn.dataset.currentState = light.adaptive_lighting_enabled;
                        toggleBtn.addEventListener('click', handleToggleAdaptive);
                        adaptiveCell.appendChild(toggleBtn);
                    });
                    streetlightsLoadingMsg.style.display = 'none';
                } catch (error) {
                    streetlightsLoadingMsg.textContent = `Error loading streetlights: ${error.message}`;
                    console.error('Error loading streetlights:', error);
                }
            }

            async function handleToggleAdaptive(event) {
                const button = event.target;
                const lightId = button.dataset.lightId;
                const currentState = button.dataset.currentState === 'true'; // Convert string to boolean
                const newState = !currentState;

                button.disabled = true;
                button.textContent = 'Updating...';

                try {
                    const response = await fetch(`/energy/streetlights/${lightId}/adaptive`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enabled: newState })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    // const updatedLight = await response.json(); // Use if needed to update more than just the button/status

                    // Update UI directly for this light
                    const row = button.closest('tr');
                    if (row) {
                        row.cells[6].textContent = newState ? "Enabled" : "Disabled"; // Update "Adaptive Lighting" text
                    }
                    button.textContent = newState ? "Disable Adaptive" : "Enable Adaptive";
                    button.dataset.currentState = newState;

                    // Optionally, re-fetch all lights if other data might have changed server-side
                    // loadStreetlights();
                    // For now, just updating the specific light's display based on successful toggle.

                } catch (error) {
                    alert(`Error toggling adaptive lighting for ${lightId}: ${error.message}`);
                    // Revert button text if needed, or simply re-enable
                    button.textContent = currentState ? "Disable Adaptive" : "Enable Adaptive";
                    console.error('Error toggling adaptive lighting:', error);
                } finally {
                    button.disabled = false;
                }
            }

            runSimulationBtn.addEventListener('click', async function() {
                const duration = parseFloat(durationInput.value);
                if (isNaN(duration) || duration <= 0) {
                    displayMessage(simulationResultDiv, 'Please enter a valid positive duration.', true);
                    return;
                }

                runSimulationBtn.disabled = true;
                runSimulationBtn.textContent = 'Simulating...';
                displayMessage(simulationResultDiv, 'Running simulation...', false, true);

                try {
                    const response = await fetch('/energy/simulation/run', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ duration_hours: duration })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }
                    displayMessage(simulationResultDiv, `Total energy consumed: ${data.total_energy_consumed_kwh.toFixed(3)} kWh`, false);
                    loadStreetlights(); // Refresh data
                } catch (error) {
                    displayMessage(simulationResultDiv, `Simulation error: ${error.message}`, true);
                    console.error('Simulation error:', error);
                } finally {
                    runSimulationBtn.disabled = false;
                    runSimulationBtn.textContent = 'Run Simulation';
                }
            });

            applyScheduleBtn.addEventListener('click', async function() {
                const hour = parseInt(hourInput.value);
                if (isNaN(hour) || hour < 0 || hour > 23) {
                    displayMessage(scheduleResultDiv, 'Please enter a valid hour (0-23).', true);
                    return;
                }

                applyScheduleBtn.disabled = true;
                applyScheduleBtn.textContent = 'Applying...';
                displayMessage(scheduleResultDiv, 'Applying schedule...', false, true);

                try {
                    const response = await fetch('/energy/adaptive_lighting/apply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ current_time_hour: hour })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }
                    displayMessage(scheduleResultDiv, `Schedule applied. Lights updated: ${data.updated_lights}. Details: ${JSON.stringify(data.details)}`, false);
                    loadStreetlights(); // Refresh data
                } catch (error) {
                    displayMessage(scheduleResultDiv, `Schedule error: ${error.message}`, true);
                    console.error('Schedule error:', error);
                } finally {
                    applyScheduleBtn.disabled = false;
                    applyScheduleBtn.textContent = 'Apply Schedule';
                }
            });

            function displayMessage(element, message, isError = false, isLoading = false) {
                element.textContent = message;
                element.className = 'status-message'; // Reset classes
                if (isError) {
                    element.classList.add('status-error');
                } else if (!isLoading) { // Don't add success for 'loading...' type messages
                    element.classList.add('status-success');
                }
                element.style.display = 'block';
            }

            // Initial load
            loadStreetlights();
        });
    </script>
</body>
</html>
